# Notes

## Todo

- [ ] delete player
- [ ] use interceptors for validation - events should be very simple, and use interceptors like enrich for validation and stuff. Like subbing someone out dissoc'ing the player if they were a shoot/rebound/stealer. That should be done via an interceptor, not cond-> logic in the event.
- [ ] I'm now using the preview db to basically transact on any action input change. So maybe I should just drop the :action part of app-db and just transact to conn every time? I guess I was originally worried about performance, but this doesn't seem to be an issue. This would also simplify adding certain action attributes like offense/players and defense/players, b/c I could just directly transact them when an action starts. And, it also allows me to do the fouled shot with a certain lineup, press sub and make substitutions after the 1st free throw, then set the missed free throw rebounder as someone who just subbed in
- [ ] generated court svg with specified dimensions
- [ ] add clojure/spec to app-db
- [ ] lineup stats
- [ ] individual stats
- [ ] svg for the whole court, but then mask parts?
- [ ] use :pre and :post assertions in important functions
- [ ] customize visible stats
- [ ] support mobile
- [ ] edit already transacted action. But you should think of it more like editting a possession, b/c you don't really want to throw off the possession alternating pattern, although this is broken at periods, so... So if you allowed just randomly deleting one possession, then you'd need a way to insert a possession in between others. Also, something you might need is editting the period of past possessions.
- [ ] So like, maybe there's a way to show the end of a period in the render-possessions component. And it would insert some kind of possession end marker in between the :game/possession 's, so that you could see end of periods. It'd need to be a stateful-transducer-kind-of-thing, but I don't think it'd be too hard

- [X] bug: if there's a free throw and people are coming into the game that haven't yet, you have to add them. But then they aren't in on-bench-ft, so they aren't available to select, so you have to deselect your free throw and then make it a free throw action again, and they'll be there
- [X] customize team/name
- [X] have a button to activate substitutions, which would also allow deleting players. This gives more space for other things there, like a second column for "object" players
- [X] two column players inputs
- [X] when a steal is selected, if the offense has a player of the same number, it'll highlight the offensive player too, rather than just the defensive player. I had this bug earlier with action/types, I think
- [X] sending datomic db to datascript
- [X] converting datomic db to datascript db
- [X] disable "Add" button if action is invalid, form validation reporting
- [X] Fix bug where you can add empty action by only selecting player. Would be nice to use a proper reagent form, using custom validators like the ol' Angular ReactiveForm has
- [X] use shared logic for these clickable button things
- [X] fix bug where on free throws with at least one miss and make, setting a rebound is required even though the make could've been at the end
- [X] have bonus do correct number of free throws - maybe a manual button to add free throw attempts? (different rules in different leagues)
- [X] fix bug where, at start of game, clicking on court causes crash
- [X] button-ify UI elements. Nobody likes using a select dropdown (however convenient it is for me, as a dev). What would be nicer is to have the selectable players all visible, and you click on their tile to select them.
    - [X] First thing is to button-ify the action/types. The radio selector is kind of lame
    Idea: you can't select a shot or action type until a player is selected. After it's selected, you can choose the action type (turnover, bonus, technical, or slicking a shot on the shot svg). After that happens, different players can be selected. If it's a miss (and reboundable?), you can select any player or team, on either team. If it's a turnover, you can select players from the defense to set a stealer. For a shot, there'll be a button foul? where you can set free throw attempts. If it's selected, there'll be vertically connected make/miss button pairs, for however many free throws there were. So one of each is required, and, if the last free throw is a miss, it'll prompt for a rebound player or team. For a bonus, maybe you can select single bonus or double bonus, and that'll determine how many free throws there are. Same thing about ending with a miss prompting for a rebound. For a technical, it'll be two free throws, no prompt for a rebound
- [X] buttons for team, to select init/team, but also to optionally set rebound/team?
- [X] the players map should have players in a set, to not allow duplicates
- [X] Button-ify the player selectors
- [X] have an action in progress above the most recent possession so that inputter can verify action before adding
- [X] start new quarter should be a checkbox, just in case you click it on accident and want to revert that
- [X] Start new game
- [X] Save new db to local/session storage on add action
- [X] refactor app-db type query operations into db.cljs, and potentially move the datascript db logic into a new file. app.events and app.subs share a lot of the same logic, and app.db is what that's supposed to be for - logic related to the app-db structure
- [X] this would be a big change - make the datascript connection behave more like the app-db and :db co/effect, where the coeffect is @conn rather than conn. Then I guess the coeffect would be the datascript-db value, and it could effect with the value of the new datascript db, which would then use reset-conn! with the new db, similar to how the :db effect uses `(reset! app-db value)`. And I guess an intermediate effect could be called with tx-data, and then it'd put the result of db-with into the :datascript-db effect. So it wouldn't use `transact!` directly? But then, wouldn't you might-as-well put the datascript db into app-db, and just `(update db :datascript-db d/db-with tx-data)`?
- [X] Fix bug where, after setting a rebound on a missed ft, made free throws is set to = attempted free throws, and thus no rebound should be possible. Maybe using a rebound interceptor, or something
- [X] Refactor rebound from :shot/rebounder to :rebound/player and :rebound/off?
- [X] Support logging team rebounds
    - could just have a rebound/team? boolean
- [X] default play numbers in :players map
- [X] Refactor a lot of `::events/add-action` into `app.db`
- [X] Make `::subs/team` dependent on `::subs/datascript-db`
    - find the last possession in the last action and determine if possession change
    - re-frame/app-db should ideally only be for things outside the datascript db
- [X] Use `::subs/init-team` for the start of periods
    - jump-balls make it hard to know possession after end of period
    - will allow cutting a possession short at end of period
    - Ex: offensive rebound, then clock expires
        - lose possession - end of possession? YES
        - keep possession - end or continuation of possession? END OF POSSESSION
- [X] Implement undo action
    - pops the last action off the datascript db
    - if action is only one in possession, pops the possession, too
    - could result in period backtracking, which is good with the way I have it
